# Docker Compose configuration for running tests
# Usage: docker-compose -f docker-compose.test.yml up --abort-on-container-exit

services:
  # PostgreSQL Database for Tests
  postgres-test:
    image: postgres:17-alpine
    container_name: health-postgres-test
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-auth_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-auth_password}
      POSTGRES_DB: ${POSTGRES_DB:-auth_db_test}
    # Port mapping - only needed if you want to access from host
    # For tests, we can remove this since containers communicate via Docker network
    # Uncomment if you need to access the test database from host:
    # ports:
    #   - "${POSTGRES_TEST_PORT:-5434}:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-auth_user} -d ${POSTGRES_DB:-auth_db_test}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - health-test-network
    restart: "no"

  # API Service Test Runner
  api-service-test:
    build:
      context: .
      dockerfile: backend/api-service/Dockerfile
      target: test-runner
    container_name: health-api-service-test
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-auth_user}:${POSTGRES_PASSWORD:-auth_password}@postgres-test:5432/${POSTGRES_DB:-auth_db_test}
      DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-5}
      DATABASE_MIN_CONNECTIONS: ${DATABASE_MIN_CONNECTIONS:-1}
      
      # Test Configuration
      RUST_BACKTRACE: 1
      RUST_LOG: ${RUST_LOG:-info}
      SQLX_OFFLINE: true
      CARGO_BUILD_JOBS: ${CARGO_BUILD_JOBS:-2}
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - health-test-network
    volumes:
      # Mount source code for tests
      - ./backend:/app/backend
      # Mount .sqlx directory for offline mode
      - ./backend/.sqlx:/app/backend/.sqlx:ro
      # Use a named volume for target directory to persist build cache
      - test_target_cache:/app/backend/target
    working_dir: /app/backend
    command: >
      sh -c "
        echo 'â³ Waiting for database to be ready...' &&
        sleep 3 &&
        echo 'ğŸ§ª Running all tests (migrations will run automatically)...' &&
        cargo test --package api-service -- --ignored --test-threads=1 --nocapture
      "
    restart: "no"

volumes:
  postgres_test_data:
  test_target_cache:

networks:
  health-test-network:
    driver: bridge

